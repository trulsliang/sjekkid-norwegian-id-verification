# Norwegian ID Verification App

## Overview

This is a full-stack web application that provides Norwegian ID verification through BankID integration. The app allows users to scan QR codes generated by the BankID "Vis legitimasjon" (Show ID) feature to verify Norwegian identity documents. It's built with a modern TypeScript stack featuring React frontend and Express backend.

## User Preferences

Preferred communication style: Simple, everyday language.
Navigation preference: Burger menu format for all admin and scanning pages.
Authentication requirement: Users must login before accessing scanning functionality.
User experience priority: Welcoming onboarding for new users with comprehensive feature explanations.
Role-based interface: Different navigation and content based on user type (admin vs regular user).

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Routing**: Wouter (lightweight React router)
- **UI Framework**: Radix UI primitives with Tailwind CSS styling
- **Component Library**: Custom components using shadcn/ui design system
- **State Management**: TanStack React Query for server state
- **Build Tool**: Vite with custom configuration for monorepo setup

### Backend Architecture
- **Framework**: Express.js with TypeScript
- **Database ORM**: Drizzle ORM with PostgreSQL
- **Database Provider**: Neon Database (serverless PostgreSQL)
- **Session Management**: In-memory storage with fallback to database
- **External API Integration**: BankID OAuth2 and Stoe API for identity verification

### Key Design Decisions
1. **Monorepo Structure**: Single repository with separate `client/`, `server/`, and `shared/` directories for code organization
2. **TypeScript Throughout**: Ensures type safety across the entire stack
3. **Shared Schema**: Common data types and validation schemas in `shared/` directory
4. **Component-Based UI**: Modular React components with consistent design system

## Key Components

### Frontend Components
- **QRScanner**: Camera-based QR code scanning using jsQR library
- **VerificationResult**: Displays verified user information and photo
- **LoadingState**: Multi-step progress indicator during verification
- **ErrorDisplay**: User-friendly error handling with retry functionality
- **HelpSection**: User guidance for the verification process
- **Burger Menu Navigation**: Collapsible hamburger menu across all admin and scanning pages
- **OnboardingTooltip**: Interactive step-by-step guide system for new users
- **Role-Based Navigation**: Adaptive menu system that shows different options based on user role

### Backend Services
- **Storage Layer**: Abstracted storage interface with in-memory implementation
- **BankID Integration**: OAuth2 token management and API communication
- **Verification Pipeline**: Multi-step process for validating QR codes and retrieving user data

### Database Schema
- **verification_sessions**: Stores session data and verification results
- **auth_tokens**: Manages BankID OAuth2 access tokens with expiration

## Data Flow

1. **User Authentication**: Users must login before accessing any functionality
2. **QR Code Scanning**: Authenticated users scan BankID QR code using device camera
3. **Session Validation**: App validates QR code format and extracts session ID
4. **BankID Authentication**: Backend obtains OAuth2 token from BankID
5. **Identity Verification**: System calls Stoe API to retrieve user information
6. **Result Display**: Verified user data and photo are displayed to user

## Recent Changes (January 2025)

### Latest Updates (January 2025)
- **API Scope Fix**: Fixed verification errors by updating to client-configured Støe API scope "vis-leg/identity_picture_age"
- **Environment Configuration**: Currently using test API URL - needs production URL configuration for live QR codes
- **UI Improvement**: Moved demo button from scanner interface to burger menu for cleaner interface
- **Android PWA Deployment**: Implemented Progressive Web App features for Android deployment including manifest.json, service worker, offline functionality, and installation prompts
- **Android Scanner Support**: Added hidden input field on scanning page for Android scanning devices to manually input QR code data
- **Splash Screen Implementation**: Added animated "SJEKK ID" branded loading page with gradient design and modern animations
- **Copyright Updates**: Updated footer text to "© TL 2025" and added support links across login and home pages
- **Access Control Refinements**: Removed delete functionality for org_admin users; only system admins can delete users
- **Organization Requirement**: Users must now be connected to an organization (database constraint enforced)
- **UI Text Updates**: Removed "admin login" and "Støe" references from front page for cleaner presentation
- **Onboarding Removal**: Removed all tooltip and onboarding functionality from all pages per user request
- **Expandable Forms**: Implemented collapsible "Legg til ny" forms for organizations and users with chevron up/down icons and smooth transitions
- **MFX ID Implementation**: Replaced organization address field with unique mfxid field, restricted to admin-only visibility for security
- **Database Migration**: Added unique constraint on mfxid field with proper error handling and data migration
- **Comprehensive Admin Reporting**: Created cross-organizational reporting system for system administrators
- **CSV Export Functionality**: Implemented CSV download for comprehensive reports including mfxid, organization name, month, scan count, and generation timestamp
- **Enhanced UX**: Improved form interactions with expandable sections and proper loading states

### August 2025 Updates
- **Deployment Fixes**: Fixed server startup issues for production deployment by using callback format for server.listen(), removing error throwing in middleware, and adding comprehensive error handling
- **Improved Error Messages**: Enhanced user experience when QR codes are reused with Norwegian language messages including timestamp and clear guidance
- **Fixed Report Counting**: Resolved critical issue where successful scans weren't being counted in reports by adding authentication to verification endpoint and linking scans to organizations and users
- **Authentication Required**: Verification endpoint now requires user authentication, improving security and enabling proper scan attribution for reporting
- **Critical Authentication Fix**: Resolved browser CORS issue where Authorization headers were stripped from `/api/verify` requests by implementing body-based authentication using `authSessionId` field, ensuring all scanning functionality works correctly
- **Authentication Flow Fixes**: Resolved authentication timing issues preventing scanning functionality, fixed routing to go directly to login page, and eliminated JavaScript timestamp formatting errors in verification results
- **Demo Scanning Separation**: Fixed demo scans being incorrectly counted in statistics by implementing proper routing logic - demo sessions (VisLeg-demo*) now automatically use `/api/verify-demo` endpoint and are not stored in database
- **Desktop Logout Implementation**: Added desktop logout buttons to all admin pages (Dashboard, Organizations, Users, Reports, Scanning) visible on desktop with username and organization information
- **Demo Button Repositioning**: Moved demo testing button from middle of scanner interface to bottom of page, underneath the "Norsk ID-verifikasjon" module with clear indication it won't count in reports
- **Demo Button Removal**: Completely removed demo button from scanning page for production deployment
- **Android APK Preparation**: Configured Capacitor for Android APK generation with proper app ID (no.tl.sjekkid), camera permissions, and HTTPS support
- **Build Environment Setup**: Created Android project structure, GitHub Actions workflow for automated APK building, and comprehensive build instructions
- **Full Platform Operational**: Norwegian identity verification platform now fully functional with working demo and authenticated scanning, proper error handling, and seamless user experience

### Organization Admin Role Implementation (January 2025)
- Added `org_admin` role to database schema and user type system
- Implemented three-tier role system: `admin` (full system access), `org_admin` (organization-scoped admin), `user` (scanning only)
- Organization admins can:
  - Manage users within their own organization only
  - Generate and view reports for their organization
  - Access dashboard with organization-specific data
  - Cannot access other organizations or system-wide settings
- Updated all API endpoints with proper authorization checks for org_admin role
- Modified frontend navigation to show role-appropriate menu options
- Created test org_admin user: username "orgadmin", password "orgadmin123"

### Navigation System Overhaul
- Implemented burger menu navigation across all admin pages and scanning interface
- Menu displays hamburger icon (☰) that toggles to X when open
- Fixed menu text visibility with proper contrast (gray text on white background)
- Current page highlighted with gray background for better UX

### Authentication Flow Updates
- Changed default landing page from home to login page (/)
- Users must authenticate before accessing scanning functionality
- Scanning page redirects to login if not authenticated
- Updated all "Start skanning" links to use /scanning route

### Role-Based Access Control
- Implemented role-based navigation system distinguishing admin and regular users
- Regular users only see scanning functionality and personal statistics ("Mine statistikker")
- Admin users have full system access: Dashboard, Organizations, Users, Reports, Scanning
- Reports page shows different content based on user role:
  - Admins: Report generation form + administrative report management
  - Users: Today's statistics (total scans, successful scans, success rate) + download functionality

### Onboarding System Implementation (REMOVED)
- Previously implemented comprehensive onboarding tooltip system - now removed per user request
- All tooltip components, onboarding hooks, and help buttons have been completely removed from the application
- Application now focuses on direct functionality without guided tours or interactive help

### UI/UX Improvements
- Mobile-responsive burger menu with collapsible navigation
- Desktop users retain traditional header with username and logout button
- Menu automatically closes when navigation links are clicked
- Consistent navigation experience across admin dashboard, organizations, users, reports, and scanning pages
- Added help accessibility features with question mark icons and tooltips

## External Dependencies

### Core Dependencies
- **@neondatabase/serverless**: Serverless PostgreSQL database connection
- **drizzle-orm**: Type-safe database ORM
- **@tanstack/react-query**: Server state management
- **@radix-ui/***: Accessible UI component primitives
- **jsqr**: QR code detection and parsing
- **wouter**: Lightweight React routing

### BankID Integration
- **OAuth2 Flow**: Uses client credentials grant for API access
- **Scopes**: `vis-leg/identity_picture_age` for identity information with picture and age
- **API Endpoints**: BankID auth server and API for user data

### Development Tools
- **Vite**: Fast development server and build tool
- **Tailwind CSS**: Utility-first CSS framework
- **PostCSS**: CSS processing with autoprefixer
- **ESBuild**: Fast JavaScript bundler for production

## Deployment Strategy

### Build Process
1. **Frontend Build**: Vite builds React app to `dist/public/`
2. **Backend Build**: ESBuild bundles Express server to `dist/index.js`
3. **Database Migrations**: Drizzle handles schema changes via `db:push`

### Environment Configuration
- **DATABASE_URL**: PostgreSQL connection string (required)
- **STOE_CLIENT_ID**: Støe API OAuth2 client identifier
- **STOE_CLIENT_SECRET**: Støe API OAuth2 client secret
- **STOE_API_URL**: Støe API base URL (currently test environment, needs production URL for live QR codes)
- **NODE_ENV**: Environment flag for development/production modes

### Hosting Requirements
- Node.js runtime environment
- PostgreSQL database (Neon recommended)
- HTTPS required for camera access in production
- BankID integration requires Norwegian regulatory compliance

### Development Setup
- **Dev Command**: `npm run dev` - Starts development server with hot reload
- **Build Command**: `npm run build` - Creates production build
- **Start Command**: `npm run start` - Runs production server
- **Database Command**: `npm run db:push` - Applies schema changes